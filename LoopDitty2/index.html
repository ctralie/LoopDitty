<html>

<head>
<meta charset=utf-8 />
<title>Loop Ditty Geometric Music Visualizer</title>
<!--External Libraries!-->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<!--<script src="http://connect.soundcloud.com/sdk.js"></script>-->
<script src="https://connect.soundcloud.com/sdk/sdk-3.1.2.js"></script>
<script type="text/javascript" src="libs/gl-matrix-min.js"></script>
<script type="text/javascript" src="libs/webgl-utils.js"></script>
<script type="text/javascript" src="libs/numeric-1.2.6.min.js"></script>
<script type="text/javascript" src="libs/interact.min.js"></script>

<!--D3 stuff!-->
<script src="libs/d3-collection.v0.1.min.js"></script>
<script src="libs/d3-dispatch.v0.3.min.js"></script>
<script src="libs/d3-dsv.v0.2.min.js"></script>
<script src="libs/d3-request.min.js"></script>
<script src="libs/d3.min.js"></script>

<!--My Scripts!-->
<script src="Cameras3D.js"></script>
<script src="DefaultCurves.js"></script>
<script src="Colormaps.js"></script>
<script src="LoopDittyGL.js"></script>
<script src="MusicFeatures.js"></script>
<script src="MatrixUtilities.js"></script>


<style>
button {
  outline: none;
  background-color: #bfbfbf;
  border: 2px solid #000;
  color: #000;
  padding: 10px 32px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
  margin: 4px 6px;
  cursor: pointer;
  border-radius: 10px;
}

body {
    background-color: #202020;
    color:#CCCCCC;
}

#sourceorder {
  font-size: 22px;
}

button:hover {
  opacity: 0.6;
}

a:hover {
    opacity: 0.6;
}

a {
color: #617944;
}

a:visited {
color: #8dae4e;
}

input[type=text] {
    background-color: #202020;
    color: #8dae4e;
    padding:8;
}

input[type=submit] {
    padding:5px 15px;
    background:#ccc;
    border:0 none;
    cursor:pointer;
    -webkit-border-radius: 5px;
    border-radius: 5px;
}

.dropbtn {
    background-color: #bfbfbf;
    color: black;
    padding: 16px;
    font-size: 16px;
    border: none;
    cursor: pointer;
}

.dropbtn:hover, .dropbtn:focus {
    opacity: 0.6;
}

.dropdown {
    position: relative;
    display: inline-block;
}

.dropdown-content {
    display: none;
    position: absolute;
    background-color: #f9f9f9;
    min-width: 160px;
    overflow: auto;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
}

.dropdown-content a {
    color: black;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
}

.dropdown a:hover {background-color: #f1f1f1}

.show {display:block;}


/* Tooltip container */
//http://www.w3schools.com/css/css_tooltip.asp
.tooltip {
    position: relative;
    display: inline-block;
    border-bottom: 1px dotted black; /* If you want dots under the hoverable text */
}

/* Tooltip text */
.tooltip .tooltiptext {
    visibility: hidden;
    width: 400px;
    background-color: black;
    color: #fff;
    text-align: left;
    padding: 10px;
    border-radius: 6px;

    /* Position the tooltip text - see examples below! */
    position: absolute;
    z-index: 1;
}

/* Show the tooltip text when you mouse over the tooltip container */
.tooltip:hover .tooltiptext {
    visibility: visible;
}


#title {
    margin: 0;
    font-size: 3em;
    text-shadow: 2px 2px 2px rgba(0, 0, 0, 0.4);
    font-family: 'Poiret One', cursive;
    margin-bottom: 10;
}

#subtitle {
    font-family: "Droid Serif", "DejaVu Serif", "Garamond", serif;
    font-size: 1.5em;
    margin-bottom: 30;
}

#paramtitle {
    font-family: "Droid Serif", "DejaVu Serif", "Garamond", serif;
    font-size: 1.5em;
    margin-top: 30;
    margin-bottom: 10;
}

#paramchoice {
    font-family: "Droid Serif", "DejaVu Serif", "Garamond", serif;
    margin-top: 5;
    margin-bottom: 5;
}

#acknowledgements {
    font-family: "Droid Serif", "DejaVu Serif", "Garamond", serif;
    font-size: 1em;
    margin-bottom: 30;
}

#directionbig {
    font-family: "Droid Sans", "DejaVu Sans", "Arial", sans-serif;
    font-weight: bold;
    font-size: 22px;
}

#grayband {
    color:#101010;
}



</style>
</head>

<body onload="webGLStart();">

<div id = "title">Loop Ditty Geometric Music Visualizer</div>
<div id = "subtitle"> by <a href = "http://www.ctralie.com">Chris Tralie</a></div>


<table>
<tr><td colspan = "2"><div id = "acknowledgements">Supported by an <a href = "https://www.nsfgrfp.org/">NSF Graduate Fellowship</a> NSF DGF 1106401
<BR>and an NSF Research Training Grant NSF-DMS 1045133.
<BR>Special thanks to <a href = "http://geomdata.com/">Geometric Data Analytics, Inc.</a> for inspiration<BR>
    and the <a href = "http://bigdata.duke.edu/data-expeditions">Duke Data Expeditions Program</a> for motivation
</div>
</td></tr>
<tr><td colspan = "2"><div id = "directionbig">Paste SoundCloud URL Below To Begin</div></td></tr>
<tr>
<td><input id = "scurl" type = "text" size = "50"></td>
<td><button type = "button" onclick = "querySoundCloudURL()">Submit</button></td>
</tr>


<tr><td colspan = "2">
    <BR>
    <h2><b>OR...</b></h2>
    <BR>
</td></tr>

<tr><td><div id = "directionbig">Load Your Own Audio File</div></td><td><input type = "file" id = "audioInput"></td></tr>


<tr><td colspan = "2">
    <BR>
    <h2>OR...</h2>
    <BR>
</td></tr>

<tr><td><div id = "directionbig">Try A Precomputed Example</div></td>

    <td>
        <div class="dropdown">
        <button onclick="dropdownHandler()" class="dropbtn">Example Songs by Artist</button>
          <div id="precomputedExamples" class="dropdown-content">
            <a href="#home">Home</a>
            <a href="#about">About</a>
            <a href="#contact">Contact</a>
          </div>
        </div>

       </td></tr>

</table>

<BR><BR>

<table>
<tr><td><HR></td><td></td></tr>
<tr>
<td width = 800>
<div id = "pagestatus"><h3><font color = "red">Waiting for Input...</font></h3></div>
</td>
</tr>

<tr><td>
<table><tr><td>
<canvas id="LoopDittyGLCanvas" style="border: none;" width="800" height="600"></canvas>
</td></tr>
<tr><td width = 800>


<div id = "manualwidget">
<input type="range" id="timeSlider" min = "0" max = "1000" value = "0" step = "1" style="width:760px"><br>
<table>
<tr>
<td><button type = "button" onclick = "playAudioButton()">&#9654;</button></td>
<td><button type = "button" onclick = "pauseAudio()">&#10073;&#10073;</button></td>
</tr>
</table>
</div>


</td></tr>
</table>


</td>
<td>

<!--Parameter Choices!-->
<table>
<tr>
<td colspan = "2">
    <div class="tooltip"><div id = "paramtitle">Display Parameters</div>
        <span class="tooltiptext">These are aesthetic animation parameters which can be updated quickly without any long re-computation</span>
    </div>

</td>
</tr>
<tr>
<td><div id = "paramchoice">
    <div class="tooltip">Display Time Edges
        <span class="tooltiptext">Choose whether or not line segments should be drawn between points which are adjacent in time in the song.</span>
    </div>
</div></td><td>
<input type="checkbox" id="timeEdgesCheckbox" /></td>
</tr>
<tr><td colspan = "2">
        <div class="tooltip"><div id = "paramtitle">Feature Choices</div>
            <span class="tooltiptext">Each point in this animation is a 3 dimensional projection of a bunch of numbers which describe perceptual aspects of a chunk of music.  As the sound changes, these numbers also change, and so the points move through space.  You can choose to include or exclude certain numbers from contributing to the position of the points by checking and unchecking the boxes below</span>
        </div>
    </div></td></tr>

<tr>
<td><div id = "paramchoice">
    <div class="tooltip">MFCC
        <span class="tooltiptext">MFCC stands for "<a href = "https://en.wikipedia.org/wiki/Mel-frequency_cepstrum">Mel-Frequency Cepstral Coefficient</a>." These 12 numbers model a highly smoothed version of the frequency spectrum of a chunk of audio.  They have been shown to work well for voice, musical artist, and musical instrument modeling.  They can be thought of as picking up on the "timbre" of the sound; or the stuff that isn't the notes.  By themselves, they should be able to separate the song into distinct regions.</span>
    </div>
</div></td><td>
<input type="checkbox" id="MFCCCheckbox" /></td>
</tr>

<tr>
<td><div id = "paramchoice">
    <div class="tooltip">Chroma
        <span class="tooltiptext">Chroma is a 12-dimension feature set used to model the strength of the 12 notes in the <a href = "https://en.wikipedia.org/wiki/Chromatic_scale">Western chromatic scale</a>, factoring out the octave that they're in (so a 440hz and an 880hz A are equivalient, for example).  This is complementary to MFCC, since it models note pitches only, attempting to factor out information about timbre.</span>
    </div>
</div></td><td>
<input type="checkbox" id="ChromaCheckbox" /></td>
</tr>

<tr>
<td><div id = "paramchoice">
    <div class="tooltip">Spectral Centroid
        <span class="tooltiptext">The spectral centroid is a single number which is the average frequency in a chunk of audio.  This number is higher with higher musical notes, high frequency vibrations from percussive instruments, and consonant vocal sounds.  Conversely, it is lower for bass instruments, lower notes, and vowel sounds.</span>
    </div>

</div></td><td>
<input type="checkbox" id="CentroidCheckbox" /></td>
</tr>

<tr>
<td><div id = "paramchoice">
    <div class="tooltip">Spectral Roloff
        <span class="tooltiptext">The spectral roloff is the frequency below which 85% of the spectral power is contained.  Songs with more bass will have a lower spectral roloff, while electronic music with lots of high frequency energy will have a higher spectral roloff.</span>
    </div>
</div></td><td>
<input type="checkbox" id="RoloffCheckbox" /></td>
</tr>

<tr>
<td><div id = "paramchoice">
    <div class="tooltip">Spectral Flux
        <span class="tooltiptext">The spectral flux is the average difference in power between each frequency index between two adjacent chunks of audio.  It is like a "frequency derivative."  In highly percussive music, high values of this feature correlate strongly with drum hits, so if you use this feature by itself, you're likely to see a curve that "waves with the beat."</span>
    </div>
</div></td><td>
<input type="checkbox" id="FluxCheckbox" /></td>
</tr>

<tr>
<td><div id = "paramchoice">
    <div class="tooltip">Zero Crossings
        <span class="tooltiptext">This is a simple but surprisingly descriptive feature that counts the number of times the audio waveform goes up and down through the zero line.  It will be higher for higher frequencies</span>
    </div>
</div></td><td>
<input type="checkbox" id="ZeroCrossingsCheckbox" /></td>
</tr>

<tr><td colspan = "2">
    <div class="tooltip"><div id = "paramtitle">Window Options</div>
        <span class="tooltiptext">Features from chunks of the audio are summarized within a "sliding window" of audio.  By default, the program takes the average value of features within each window, but it is also possible to report the variation of the features within the window. </span>
    </div>
</div></td></tr>

<tr>
    <td><div id = "paramchoice">
        <div class="tooltip">Window Length
            <span class="tooltiptext">This is the length in seconds of the window that is used to summarize the features taken in chunks of audio.  Features are computed in 23 millisecond chunks, so the default value of 3.5 seconds corresponds to averaging roughly 150 windows.  The longer the window is, the more sound is summarized by the window, which means the points in the animation are likely to be more distinct.</span>
        </div>
    </div></td>
    <td><input id = "windowLength" type = "text" value = "3.5" size = "1"></td>
</tr>

<tr><td><div id = "paramchoice">
    <div class="tooltip">Sphere Normalize
        <span class="tooltiptext">For certain sections of audio that are quieter or very distinct from others, it may be the case that the animation spreads out with long tails.  Sphere normalization makes the magnitude of each feature point in the high dimensional space to be the same before the projection.  In plain English, it tries to distribute the points out more evenly.</span>
    </div>
</div></td>
<td><input type="checkbox" id="SphereNormalizeCheckbox" /></td></td></tr>
<tr><td><div id = "paramchoice">
    <div class="tooltip">Use Variation
        <span class="tooltiptext">In addition to reporting the mean of all of the features in a window, it is also possible to tack on more numbers that report how volatile each feature is in the window.  This is similar to the variance or standard deviation of features.  Computation will take slightly longer, but you may get more distinct points in your animation.</span>
    </div>
</div></td>
<td><input type="checkbox" id="UseVariationCheckbox" /></td></td></tr>
<tr><td colspan = "2"><BR><BR><button type = "button" id = "recompute" onclick = "updateParams()">Recompute Embedding</button></td></tr>

</table>


</td>
</tr></table>

<script>
    var source = null;
    var analyser = null;
    var context = new (window.AudioContext || window.webkitAudioContext)();
    var buffer = null;
    var waitingDisp = document.getElementById("pagestatus");


    function disconnect() {
        source.stop();
        source.disconnect(0);
        analyser.disconnect(0);
    }

    //TODO: Change this for some precomputed examples
    function loadSong(fields, songfilename) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', songfilename, true);
        xhr.responseType = 'arraybuffer';
        xhr.onload = function(err) {
            context.decodeAudioData(this.response, function(buff) {
            buffer = buff;
            parseText(fields);
            loading = false;
            }, function(e) {
                console.log(e);
            });
        };
        loading = true;
        ndots = 0;
        changeLoad();
        xhr.send();
    }

    function playAudioButton() {
        if (!playing) {
            //Prevent the user from accidentally playing multiple audio streams
            playAudio();
        }
    }

    function playAudio() {
        if (context === null) {
            return;
        }
        playing = true;
        source = context.createBufferSource();
        source.buffer = buffer;
        analyser = context.createAnalyser();
        source.connect(analyser);
        analyser.connect(context.destination);

        startTime = context.currentTime;

        //setTimeout(disconnect, source.buffer.duration * 1000 +1000);

        source.start(context.currentTime, offsetTime, buffer.duration - offsetTime);

        playIdx = 0;
        requestAnimFrame(function(){repaintWithContext(context)});
    }

    function pauseAudio() {
        if (source === null) {
            return;
        }
        playing = false;
        source.stop();
        offsetTime = context.currentTime - startTime + offsetTime;
    }

    function decodeAudio(arrayBuff) {
        if(context.decodeAudioData) {
            context.decodeAudioData(arrayBuff, function(buff) {
            buffer = buff;
            }, function(e) {
                console.log(e);
                alert("Error Decoding Audio");
            });
        } else {
            buffer = context.createBuffer(data, false /*mixToMono*/);
            alert("Error Decoding Audio");
            playAudio();
        }
    }

    //Loading in a custom song
    var audioInput = document.getElementById('audioInput');
    audioInput.addEventListener('change', function(e) {
        pauseAudio();
        var reader = new FileReader();
        reader.onload = function(event) {
            decodeAudio(event.target.result);
        }
        reader.readAsArrayBuffer(audioInput.files[0]);
        queryCustomFeatures(audioInput.files[0]);
    });


    var timeSlider = document.getElementById('timeSlider');
    timeSlider.addEventListener('change', function(e) {
        if (buffer === null) {
            return;
        }
        offsetTime = buffer.duration*parseFloat(timeSlider.value)/1000.0;
        playIdx = 0;
        requestAnimFrame(function(){repaintWithContext(context)});
        if (playing) {
            source.stop();
            playAudio();
        }
    });

    var timeEdgesCheckbox = document.getElementById('timeEdgesCheckbox');
    timeEdgesCheckbox.addEventListener('change', function(e) {
        MusicParams.displayTimeEdges = timeEdgesCheckbox.checked;
        requestAnimFrame(function(){repaintWithContext(context)});
    });
    timeEdgesCheckbox.checked = true;

    var recomputeButton = document.getElementById("recompute");
    var MFCCCheckbox = document.getElementById('MFCCCheckbox');
    MFCCCheckbox.addEventListener('change', function(e) {
        MusicParams.usingMFCC = MFCCCheckbox.checked;
        MusicParams.needsUpdate = true;
        recomputeButton.style.backgroundColor = "red";
        requestAnimFrame(function(){repaintWithContext(context)});
    });
    MFCCCheckbox.checked = true;

    var ChromaCheckbox = document.getElementById('ChromaCheckbox');
    ChromaCheckbox.addEventListener('change', function(e) {
        MusicParams.usingChroma = ChromaCheckbox.checked;
        MusicParams.needsUpdate = true;
        recomputeButton.style.backgroundColor = "red";
        requestAnimFrame(function(){repaintWithContext(context)});
    });
    ChromaCheckbox.checked = true;

    var CentroidCheckbox = document.getElementById('CentroidCheckbox');
    CentroidCheckbox.addEventListener('change', function(e) {
        MusicParams.usingCentroid = CentroidCheckbox.checked;
        MusicParams.needsUpdate = true;
        recomputeButton.style.backgroundColor = "red";
        requestAnimFrame(function(){repaintWithContext(context)});
    });
    CentroidCheckbox.checked = true;

    var RoloffCheckbox = document.getElementById('RoloffCheckbox');
    RoloffCheckbox.addEventListener('change', function(e) {
        MusicParams.usingRoloff = RoloffCheckbox.checked;
        MusicParams.needsUpdate = true;
        recomputeButton.style.backgroundColor = "red";
        requestAnimFrame(function(){repaintWithContext(context)});
    });
    RoloffCheckbox.checked = true;

    var FluxCheckbox = document.getElementById('FluxCheckbox');
    FluxCheckbox.addEventListener('change', function(e) {
        MusicParams.usingFlux = FluxCheckbox.checked;
        MusicParams.needsUpdate = true;
        recomputeButton.style.backgroundColor = "red";
        requestAnimFrame(function(){repaintWithContext(context)});
    });
    FluxCheckbox.checked = true;

    var ZeroCrossingsCheckbox = document.getElementById('ZeroCrossingsCheckbox');
    ZeroCrossingsCheckbox.addEventListener('change', function(e) {
        MusicParams.usingZeroCrossings = ZeroCrossingsCheckbox.checked;
        MusicParams.needsUpdate = true;
        recomputeButton.style.backgroundColor = "red";
        requestAnimFrame(function(){repaintWithContext(context)});
    });
    ZeroCrossingsCheckbox.checked = true;

    var SphereNormalizeCheckbox = document.getElementById('SphereNormalizeCheckbox');
    SphereNormalizeCheckbox.addEventListener('change', function(e) {
        MusicParams.sphereNormalize = SphereNormalizeCheckbox.checked;
        MusicParams.needsUpdate = true;
        recomputeButton.style.backgroundColor = "red";
        requestAnimFrame(function(){repaintWithContext(context)});
    });
    SphereNormalizeCheckbox.checked = false;

    var UseVariationCheckbox = document.getElementById('UseVariationCheckbox');
    UseVariationCheckbox.addEventListener('change', function(e) {
        MusicParams.usingDerivatives = UseVariationCheckbox.checked;
        MusicParams.needsUpdate = true;
        recomputeButton.style.backgroundColor = "red";
        requestAnimFrame(function(){repaintWithContext(context)});
    });
    UseVariationCheckbox.checked = false;

    var windowLengthText = document.getElementById('windowLength');
    windowLengthText.value = "" + MusicParams.TimeWin;
    windowLengthText.addEventListener('input', function() {
        MusicParams.needsUpdate = true;
        recomputeButton.style.backgroundColor = "red";
    })

    function dropdownHandler() {
        document.getElementById("precomputedExamples").classList.toggle("show");
    }

</script>



</body>
</html>
