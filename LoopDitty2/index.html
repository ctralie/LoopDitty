<html>

<head>
<!--External Libraries!-->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<!--<script src="http://connect.soundcloud.com/sdk.js"></script>-->
<script src="https://connect.soundcloud.com/sdk/sdk-3.1.2.js"></script>
<script type="text/javascript" src="libs/gl-matrix-min.js"></script>
<script type="text/javascript" src="libs/webgl-utils.js"></script>
<script type="text/javascript" src="libs/numeric-1.2.6.min.js"></script>
<script type="text/javascript" src="libs/interact.min.js"></script>

<!--D3 stuff!-->
<script src="libs/d3-collection.v0.1.min.js"></script>
<script src="libs/d3-dispatch.v0.3.min.js"></script>
<script src="libs/d3-dsv.v0.2.min.js"></script>
<script src="libs/d3-request.min.js"></script>
<script src="libs/d3.min.js"></script>

<!--My Scripts!-->
<script src="Cameras3D.js"></script>
<script src="DefaultCurves.js"></script>
<script src="Colormaps.js"></script>
<script src="LoopDittyGL.js"></script>
<script src="MusicFeatures.js"></script>
<script src="MatrixUtilities.js"></script>


<style>
button {
  outline: none;
  background-color: #bfbfbf;
  border: 2px solid #000;
  color: #000;
  padding: 10px 32px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
  margin: 4px 6px;
  cursor: pointer;
  border-radius: 10px;
}

body {
    background-color: #202020;
    color:#CCCCCC;
}

#sourceorder {
  font-size: 22px;
}

button:hover {
  opacity: 0.6;
}

a:hover {
    opacity: 0.6;
}

a {
color: #617944;
}

a:visited {
color: #8dae4e;
}

#title {
    margin: 0;
    font-size: 3em;
    text-shadow: 2px 2px 2px rgba(0, 0, 0, 0.4);
    font-family: 'Poiret One', cursive;
    margin-bottom: 10;
}

#subtitle {
    font-family: "Droid Serif", "DejaVu Serif", "Garamond", serif;
    font-size: 1.5em;
    margin-bottom: 30;
}

#directionbig {
    font-family: "Droid Sans", "DejaVu Sans", "Arial", sans-serif;
    font-weight: bold;
    font-size: 22px;
}

#grayband {
    color:#101010;
}

input[type=text] {
    width: 600px;
    background-color: #202020;
    color: #8dae4e;
    padding:8;
}

input[type=submit] {
    padding:5px 15px;
    background:#ccc;
    border:0 none;
    cursor:pointer;
    -webkit-border-radius: 5px;
    border-radius: 5px;
}


.dropbtn {
    background-color: #bfbfbf;
    color: black;
    padding: 16px;
    font-size: 16px;
    border: none;
    cursor: pointer;
}

.dropbtn:hover, .dropbtn:focus {
    opacity: 0.6;
}

.dropdown {
    position: relative;
    display: inline-block;
}

.dropdown-content {
    display: none;
    position: absolute;
    background-color: #f9f9f9;
    min-width: 160px;
    overflow: auto;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
}

.dropdown-content a {
    color: black;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
}

.dropdown a:hover {background-color: #f1f1f1}

.show {display:block;}

</style>
</head>

<body onload="webGLStart();">

<div id = "title">Loop Ditty Geometric Music Visualizer</div>
<div id = "subtitle"> by <a href = "http://www.ctralie.com">Chris Tralie</a></div>
Supported by an <a href = "https://www.nsfgrfp.org/">NSF Graduate Fellowship</a> NSF DGF 1106401.
<BR>Special thanks to <a href = "http://geomdata.com/">Geometric Data Analytics, Inc.</a> and the <a href = "http://bigdata.duke.edu/data-expeditions">Duke Data Expeditions Program</a> for inspiration
<BR><BR><BR>
<div id = "directionbig">Paste SoundCloud URL Below To Begin</div>
<table><tr>
<td><input id = "scurl" type = "text" size = "50"></td>
<td><button type = "button" onclick = "querySoundCloudURL()">Submit</button></td>
</tr>


<tr><td colspan = "2">
    <BR>
    <h2><b>OR...</b></h2>
    <BR>
</td></tr>

<tr><td><div id = "directionbig">Load Your Own Audio File</div></td><td><input type = "file" id = "audioInput"></td></tr>


<tr><td colspan = "2">
    <BR>
    <h2>OR...</h2>
    <BR>
</td></tr>

<tr><td><div id = "directionbig">Try A Precomputed Example</div></td>

    <td>
        <div class="dropdown">
        <button onclick="dropdownHandler()" class="dropbtn">Example Songs by Artist</button>
          <div id="precomputedExamples" class="dropdown-content">
            <a href="#home">Home</a>
            <a href="#about">About</a>
            <a href="#contact">Contact</a>
          </div>
        </div>

       </td></tr>

</table>

<BR><BR>

<table>
<tr><td><HR></td><td></td></tr>
<tr>
<td width = 800 bgcolor = "#181818">
<div id = "pagestatus"><h3><font color = "red">Waiting for Input...</font></h3></div>
</td>
</tr>

<tr><td>
<table><tr><td>
<canvas id="LoopDittyGLCanvas" style="border: none;" width="800" height="600"></canvas>
</td></tr>
<tr><td width = 800>


<div id = "manualwidget">
<input type="range" id="timeSlider" min = "0" max = "1000" value = "0" step = "1" style="width:760px"><br>
<table>
<tr>
<td><button type = "button" onclick = "playAudioButton()">&#9654;</button></td>
<td><button type = "button" onclick = "pauseAudio()">&#10073;&#10073;</button></td>
</tr>
</table>
</div>


</td></tr>
</table>


</td>
<td>

<!--Parameter Choices!-->
<table>
<tr><td>Display Time Edges</td><td>
<input type="checkbox" id="timeEdgesCheckbox" />
</td>
</tr>
</table>


</td>
</tr></table>

<script>
    var source = null;
    var analyser = null;
    var context = new (window.AudioContext || window.webkitAudioContext)();
    var buffer = null;
    var displayTimeEdges = true;
    var waitingDisp = document.getElementById("pagestatus");


    function disconnect() {
        source.stop();
        source.disconnect(0);
        analyser.disconnect(0);
    }

    //TODO: Change this for some precomputed examples
    function loadSong(fields, songfilename) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', songfilename, true);
        xhr.responseType = 'arraybuffer';
        xhr.onload = function(err) {
            context.decodeAudioData(this.response, function(buff) {
            buffer = buff;
            parseText(fields);
            loading = false;
            }, function(e) {
                console.log(e);
            });
        };
        loading = true;
        ndots = 0;
        changeLoad();
        xhr.send();
    }

    function playAudioButton() {
        if (!playing) {
            //Prevent the user from accidentally playing multiple audio streams
            playAudio();
        }
    }

    function playAudio() {
        if (context === null) {
            return;
        }
        playing = true;
        source = context.createBufferSource();
        source.buffer = buffer;
        analyser = context.createAnalyser();
        source.connect(analyser);
        analyser.connect(context.destination);

        startTime = context.currentTime;

        //setTimeout(disconnect, source.buffer.duration * 1000 +1000);

        source.start(context.currentTime, offsetTime, buffer.duration - offsetTime);

        playIdx = 0;
        requestAnimFrame(function(){repaintWithContext(context)});
    }

    function pauseAudio() {
        if (source === null) {
            return;
        }
        playing = false;
        source.stop();
        offsetTime = context.currentTime - startTime + offsetTime;
    }

    function decodeAudio(arrayBuff) {
        if(context.decodeAudioData) {
            context.decodeAudioData(arrayBuff, function(buff) {
            buffer = buff;
            }, function(e) {
                console.log(e);
                alert("Error Decoding Audio");
            });
        } else {
            buffer = context.createBuffer(data, false /*mixToMono*/);
            alert("Error Decoding Audio");
            playAudio();
        }
    }

    function dropdownHandler() {
        document.getElementById("precomputedExamples").classList.toggle("show");
    }

    //Loading in a custom song
    var audioInput = document.getElementById('audioInput');
    audioInput.addEventListener('change', function(e) {
        pauseAudio();
        var reader = new FileReader();
        reader.onload = function(event) {
            decodeAudio(event.target.result);
        }
        reader.readAsArrayBuffer(audioInput.files[0]);
        queryCustomFeatures(audioInput.files[0]);
    });


    var timeSlider = document.getElementById('timeSlider');
    timeSlider.addEventListener('change', function(e) {
        if (buffer === null) {
            return;
        }
        offsetTime = buffer.duration*parseFloat(timeSlider.value)/1000.0;
        playIdx = 0;
        requestAnimFrame(function(){repaintWithContext(context)});
        if (playing) {
            source.stop();
            playAudio();
        }
    });

    var timeEdgesCheckbox = document.getElementById('timeEdgesCheckbox');
    timeEdgesCheckbox.addEventListener('change', function(e) {
        displayTimeEdges = timeEdgesCheckbox.checked;
        requestAnimFrame(function(){repaintWithContext(context)});
    });
    timeEdgesCheckbox.checked = true;

</script>


</body>
</html>
